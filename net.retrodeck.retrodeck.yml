app-id: net.retrodeck.retrodeck
runtime: org.kde.Platform
runtime-version: "6.5"
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm16      # Needed for rpcs3 (llvm15) but llvm16 for CITRA
# base: io.qt.qtwebengine.BaseApp             # Needed for Yuzu - Disabled as we're using AppImage for Yuzu
# base-version: "6.5"                         # Needed for Yuzu - Disabled as we're using AppImage for Yuzu
command: retrodeck.sh

add-extensions:
  org.ppsspp.PPSSPP.Locale:
    directory: share/locale
    bundle: true
    no-autodownload: false
    subdirectories: false
    autodelete: true
    locale-subset: true

finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=ipc
  - --share=network
  - --device=all
  - --filesystem=home
  - --filesystem=/run/media
  - --filesystem=/media
  - --filesystem=home/.var/app/com.valvesoftware.Steam
  - --allow=multiarch
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.PowerManagement.Inhibit
  - --talk-name=org.freedesktop.login1.Manager
  - --talk-name=org.freedesktop.portal.Flatpak.UpdateMonitor
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  - --filesystem=xdg-config/gtk-3.0:ro
  # Dolphin
  - --allow=bluetooth
  # PPSSPP
  # It allows an SDL application to specify its window class, which can be useful for window managers and desktop environments to identify and group similar windows
  - --env=SDL_VIDEO_X11_WMCLASS=net.retrodeck.retrodeck
  - --env=SDL_VIDEO_WAYLAND_WMCLASS=net.retrodeck.retrodeck
  # XEMU - Fixes issues with openSUSE systems, QEMU_AUDIO_DRV is defined as "pa" causing xemu to not launch
  - --unset-env=QEMU_AUDIO_DRV

cleanup:
  # ES-DE
  - /include
  - /share/ffmpeg
  - /lib/cmake
  - /lib/pkgconfig
  # Yuzu
  - /include
  - /bin/glslangValidator
  - /bin/zip*
  - /bin/zstd*
  - /lib/pkg-config
  - /share/doc
  - /share/man
  - /src
  - '*.a'
  - '*.la'
  # XMLSTARLET
  - /lib/debug
  - /share/runtime
#cleanup-commands:
  # Yuzu
  #- /app/cleanup-BaseApp.sh

modules:

  # dependency of: CEMU, CITRA, DOLPHIN
  - rd-submodules/shared-modules/libusb/libusb.json

  # This module is used to define the RetroDECK version
  # If the version is set as cooker it will automatically generate the version tag based on the date
  # else it will just put what is written, "v" is not needed
  # The version number is hardcoded in /app/retrodeck/version
  #
  # UPDATE STEPS FOR MAIN:
  # [ ] Update the VERSION variable on line containing "VERSION=THISBRANCH"
  # [ ] Update the appdata.xml with the version number and notes
  #
  - name: version-initialization
    buildsystem: simple
    build-commands:
      - |

        # on main please update this with the version variable, eg: VERSION='0.7.4b'
        # on cooker will be THISBRANCH
        VERSION=THISBRANCH

        git checkout ${GITHUB_REF_NAME}
        mkdir -p ${FLATPAK_DEST}/retrodeck/
        if [[ $VERSION == *"cooker"* ]];
        then
          VERSION="$VERSION-VERSIONPLACEHOLDER"
        fi
        echo $VERSION >> ${FLATPAK_DEST}/retrodeck/version
        cat ${FLATPAK_DEST}/retrodeck/version
        echo "Version is $VERSION"
    sources:
      - type: git
        url: https://github.com/XargonWan/RetroDECK.git
        branch: THISBRANCH
  
  # MAME - Start
  # https://sdlmame.wallyweek.org/download/

  - name: mame
    buildsystem: simple
    build-commands:
      - ar xv mame*.deb
      - tar xvf control.tar.zst
      - tar xvf data.tar.zst
      - rm -rf usr/share/[applications,docs,games]
      - cp -r etc ${FLATPAK_DEST}
      - cp -r usr ${FLATPAK_DEST}
      - mkdir -p ${FLATPAK_DEST}/bin
      - ln -s ${FLATPAK_DEST}/usr/games/mame ${FLATPAK_DEST}/bin/mame
      - chmod +x ${FLATPAK_DEST}/bin/mame
    sources:
      - type: file
        url: http://de.archive.ubuntu.com/ubuntu/pool/universe/m/mame/mame_0.242+dfsg.1-1_amd64.deb
        sha256: e3d785d26dfb477519608d63114882487f8c5eb7382eb252784ed7515e2ef281

  - name: mame-data
    buildsystem: simple
    build-commands:
      - ar xv mame*.deb
      - tar xvf control.tar.zst
      - tar xvf data.tar.zst
      - cp -r usr ${FLATPAK_DEST}
    sources:
      - type: file
        url: http://ge.archive.ubuntu.com/ubuntu/pool/universe/m/mame/mame-data_0.242+dfsg.1-1_all.deb
        sha256: c1a560f41f2ddff03810f121825b9a2d1ca615899d07a57a9a8fa62506de7d27

  # MAME - End

  # External manifests end

  - name: retrodeck
    buildsystem: simple
    build-commands:

      # Initializing RO retrodeck config folder
      - mkdir -p ${FLATPAK_DEST}/retrodeck

      # Prep the ES-DE and RetroArch config files - I will have to SED/XMLSTARLET them soon
      - rm -rf /app/share/emulationstation/resources/systems/unix/es_find_rules.xml
      - cp es-configs/es_find_rules.xml /app/share/emulationstation/resources/systems/unix/
      - rm -rf /app/share/emulationstation/resources/systems/unix/es_systems.xml
      - cp es-configs/es_systems.xml /app/share/emulationstation/resources/systems/unix/
      # These must be put in home folder, managed by retrodeck.sh
      - cp es-configs/es_settings.xml ${FLATPAK_DEST}/retrodeck/es_settings.xml
      - mv -f -t ${FLATPAK_DEST}/retrodeck es-configs/rd_prepacks

      # Logo, res, move graphics directory away from default location so splash can be changed after build
      - mv -f -t ${FLATPAK_DEST}/retrodeck /app/share/emulationstation/resources/graphics
      - cp -f res/splash.svg ${FLATPAK_DEST}/retrodeck/graphics/splash.svg
      - cp -f res/splash.svg ${FLATPAK_DEST}/retrodeck/graphics/splash-orig.svg
      - cp -rf res/extra_splashes/ ${FLATPAK_DEST}/retrodeck/graphics
      - cp -f res/icon.svg /app/share/icons/hicolor/scalable/apps/net.retrodeck.retrodeck.svg
      - mv -f -t ${FLATPAK_DEST}/retrodeck res/binding_icons

      # RetroDECK core script
      - cp retrodeck.sh /app/bin/retrodeck.sh
      - chmod +x /app/bin/retrodeck.sh

      # Tools
      - mkdir -p /app/tools
      - cp -r tools/** /app/tools
      - find /app/tools -name '*.py|*.sh' -exec chmod +x {} \;

      # Function libraries
      - mkdir -p /app/libexec
      - cp -r functions/** "/app/libexec/"

      # Desktop entries
      - cp net.retrodeck.retrodeck.desktop /app/share/applications/net.retrodeck.retrodeck.desktop
      - cp net.retrodeck.retrodeck.Configurator.desktop /app/share/applications/net.retrodeck.retrodeck.Configurator.desktop
      - chmod +x net.retrodeck.retrodeck*desktop

      # Initializing default emulator configs
      - cp -r emu-configs ${FLATPAK_DEST}/retrodeck/emu-configs/

      # PICO-8 wrapper
      - cp ${FLATPAK_DEST}/retrodeck/emu-configs/pico-8/pico8-wrapper.sh /app/bin/pico8
      - chmod +x /app/bin/pico8

      # Needed for ffmpeg (RPCS3)
      - mkdir -p ${FLATPAK_DEST}/lib/ffmpeg

      # Placing appdata
      - mkdir -p ${FLATPAK_DEST}/share/appdata
      - cp net.retrodeck.retrodeck.appdata.xml ${FLATPAK_DEST}/share/appdata

      # Creating symlinks for a prettier access
      - ln -s /app/bin/retrodeck.sh /app/bin/retrodeck
      - ln -s /app/tools/configurator.sh /app/bin/configurator

      # GZDOOM wrapper
      - cp emu-configs/gzdoom/gzdoom.sh ${FLATPAK_DEST}/bin/gzdoom.sh
      - chmod +x ${FLATPAK_DEST}/bin/gzdoom.sh

    sources:
      - type: git
        url: https://github.com/XargonWan/RetroDECK.git
        branch: THISBRANCH